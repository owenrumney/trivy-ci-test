# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- main


parameters:
  - name: platform
    type: string
    default: linux

jobs:
- job: scan_image
  steps:

  - task: trivy-dev@1
    inputs:
      docker: false
      version: 'v0.67.2'
      type: 'filesystem'
      path: '.'
      scanners: 'vuln,misconfig'
      cyclonedxOutput: true

  - task: trivy-dev@2
    name: 'trivy_${{ parameters.platform }}'
    inputs:
      trivyUrl: 'https://localhost:8443/trivy_0.67.2_Linux-64bit.tar.gz'
      version: '0.67.2'
      type: 'filesystem'
      target: '.'
      scanners: 'vuln,misconfig'
      showSuppressed: true
      reports: 'cyclonedx'
      publish: true
    env:
      NODE_EXTRA_CA_CERTS: /home/owen/local-repo/rootCA.pem

  # - task: Bash@3
  #   displayName: "Print Trivy CycloneDX report"
  #   condition: always()    # ensures it runs even if Trivy failed
  #   inputs:
  #     targetType: 'inline'
  #     script: |
  #       echo "üîç Checking Trivy CycloneDX report variable..."
  #       echo "Report path: $(trivy_${{ parameters.platform }}.cyclonedxReport)"
  #       echo ""

  #       if [ -f "$(trivy_${{ parameters.platform }}.cyclonedxReport)" ]; then
  #         echo "------ üìÑ CycloneDX Report Contents ------"
  #         cat "$(trivy_${{ parameters.platform }}.cyclonedxReport)"
  #         echo "-----------------------------------------"
  #       else
  #         echo "‚ö†Ô∏è File not found at path: $(trivy_${{ parameters.platform }}.cyclonedxReport)"
  #       fi